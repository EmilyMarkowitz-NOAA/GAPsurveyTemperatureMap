---
output:
  pdf_document:
    latex_engine: xelatex
classoption: landscape
geometry: margin=1cm
mainfont: Arial Narrow
header-includes:
- \usepackage{caption}
- \captionsetup[figure]{labelformat=empty}
- \fontsize{12}{22}
- \fontseries{b}
- \selectfont
- \pagenumbering{gobble}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, comment = FALSE, message = FALSE, warning = FALSE, error = FALSE)
# output:
#   pdf_document:
#     latex_engine: xelatex
```

```{r write_caption}

vess <- text_list(x = paste0("F/V \\textit{",
                             unique(gsub(pattern = "F/V ", replacement = "", fixed = TRUE, 
                                         x = dat$vessel_name[!is.na(dat$vessel_name)])),"}"))

surveys <- gsub(pattern = " Sea", replacement = " sea", 
                x = unique(dat_plot$region_long))
SRVYs <- unique(dat_plot$SRVY)

goaai_regions <- ifelse(SRVY %in% c("AI", "GOA"), 
                       paste0("This survey covers the ", text_list(unique(survey_area$survey.grid$region)), 
           " regions, which are randomly sampled each year. "), 
                       "")

intro0 <- paste0(
    "NOAA Fisheries conducted the ", 
      text_list(surveys),
      " bottom trawl survey",
      ifelse(length(surveys)>1, "s", "")
      ," in ", maxyr, 
      " aboard the ",
      vess,
      ". ", 
    ifelse(names(params) %in% "reg0", 
           paste0("This map highlights survey progress in ", 
                  params$reg0, " region. "),
           ""), 
    goaai_regions)

foss0 <- paste0("Data have ", 
                ifelse(data_source == "gd", "NOT ", ""), 
                "been through final review. Final, validated haul and catch data will be publicly accessible on FOSS platform (\\textit{https://www.fisheries.noaa.gov/foss}). ")

if (file_end %in% c("mean")) {
  temp <- strsplit(x = plot_title, split = "\n", fixed = TRUE)[[1]][[2]]
  for (iiii in 1:length(SRVYs)) {
    temp <- gsub(pattern = SRVYs[iiii], 
         replacement = paste0(surveys[iiii]), 
         x = temp)
  }
  
  
  fig_cap <- paste0(
    "Mean ", tolower(params$var00), "s in the ", 
    temp, ". ", 
    foss0)
  
} else if (file_end %in% c("anom")) {
  
  fig_cap <- paste0(
    intro0,
"The ", 
    gsub(pattern = "\n", 
         replacement = paste0("is compared to ", params$var00," from ", maxyr, " to "), 
         x = plot_title), 
    ". ", 
    foss0)
  
} else if (file_end == "grid") { # (as.character(dates0[1]) == "none") {
  
  if (SRVY %in% c("BS", "NBS", "EBS")) {
    fig_cap <- paste0( 
      "The empty grid of stations across the ",text_list(surveys)," bottom trawl survey area",
      ifelse(length(surveys)>1, "s", ""),
             paste0(" and ", text_list(x = paste0(unique(survey_area$bathymetry$METERS), "m")),
                    " bathymetry. "))
  } else if (SRVY %in% c("GOA", "AI")) {
    fig_cap <- paste0(
      "NOAA Fisheries ", surveys, " bottom trawl survey regions. ", 
      goaai_regions)
  }
  
} else if (file_end == "daily") {
  
  loc <- dat_plot %>% 
    dplyr::filter(!is.na(var) & 
                    date == max_date) 
  
  if (nrow(loc) == 0) {
    stations1 <- "no stations were sampled. "
  } else {
    
    dat_max_date <- as(grid_stations_plot, 'Spatial') %>%
      sp::spTransform(x = ., CRS("+proj=longlat +datum=WGS84"))
    
    dat_max_date <- 
      cbind.data.frame(station = dat_max_date$station, 
                       stratum = dat_max_date$stratum, 
                       sp::coordinates(dat_max_date)) %>% 
      dplyr::rename(lon = "1", 
                    lat = "2") %>%
      dplyr::mutate(stratum = as.character(stratum)) %>%
      data.frame() %>%
      dplyr::left_join(y = ., 
                       x = loc %>% 
                         dplyr::mutate(stratum = as.character(stratum)) %>% 
                         dplyr::select(stratum, station, vessel_shape, vessel_name, date, var_bin), 
                       by = c("stratum", "station"))  %>%
      dplyr::arrange(vessel_shape) %>% 
      dplyr::mutate(lon = round(x = lon, digits = 3), 
                    lat = round(x = lat, digits = 3)) 
    
    dat_max_date <- dat_max_date %>% 
      dplyr::filter(!is.na(lon))
    
    temp <- c()
    for (iii in 1:length(unique(dat_max_date$vessel_shape))) {
      surveys <- dat_max_date[which(dat_max_date$vessel_shape == unique(dat_max_date$vessel_shape)[iii]),]
      temp <- c(temp, 
                paste0(# nrow(surveys), 
                  # " station",
                  # ifelse(nrow(surveys)>1, "s", "")," with ",
                  ifelse(nrow(surveys)>1, "", "a "), "station", # ID", 
                  ifelse(nrow(surveys)>1, "s", ""), " ", #" of ",
                  text_list(x = 
                              paste0(surveys$station,
                                     " (",surveys$lat,"°N, ",surveys$lon,"°W; ",
                                     gsub(pattern = " ", 
                                          replacement = "", 
                                          x = surveys$var_bin, fixed = TRUE),"°C)")), 
                  " ", ifelse(nrow(surveys)>1, "were", "was"), " surveyed by the F/V \\textit{",
                  gsub(pattern = "F/V ", 
                       replacement = "", 
                       fixed = TRUE,
                       x = unique(surveys$vessel_name[!is.na(surveys$vessel_name)])),"}") )
    }
    
    stations1 <- paste0(text_list(temp))
    
    if (!is.null(dat_planned)) {
      if (length(dat_planned) == 0){
        
        if ((date_entered[length(date_entered)] == max_date & data_source == "haul")) {
          stations1 <- paste0(stations1, ". This is the last day of the survey. ")
        } else {
          stations1 <- paste0(stations1, ". There are no stations planned for ", 
                              format_date_txt(x = (as.Date(max_date)+1)), ". ")
        }
      } else {
        if ((date_entered[length(date_entered)] == max_date & sum(is.na(dat$var))>0)) {
          stations1 <- paste0(stations1, ". This is the last day of the survey. ")
        } else {
          stations1 <- 
            paste0(stations1, ". There are ",
                   nrow(dat_planned[dat_planned$planned == "Y",])," stations planned for ", 
                   format_date_txt(x = (as.Date(max_date)+1)), ". ")
        }
      }
    } else {
      stations1 <- paste0(stations1, ". ")
    }
  }
  
  fig_cap <- paste0(intro0, 
    "Near real-time ocean bottom temperatures collected ", 
    ifelse(min(as.Date(dat$date), na.rm = TRUE) == max_date, 
           paste0("on ", format_date_txt(x = min(as.Date(dat$date), na.rm = TRUE), "%B %d %Y")), 
           paste0(" ", format_date_txt(x = min(as.Date(dat$date), na.rm = TRUE), "%B %d"), 
                  "-", 
                  format_date_txt(x = as.Date(max_date), "%B %d %Y"))), ". ", 
    "On ", format_date_txt(as.Date(max_date)), ", ",
    stations1)
  
}

fig_alt <- fig_cap <- paste0(fig_cap, "\\textit{Credit: NOAA Fisheries}")

fig_alt <- gsub(pattern = "\\textit{", replacement = "", x = fig_alt, fixed = TRUE)
fig_alt <- gsub(pattern = "}", replacement = "", x = fig_alt, fixed = TRUE)
# fig_alt <- gsub(pattern = " (https://www.fisheries.noaa.gov/foss)",
#                 replacement = "", 
#                 x = fig_alt, 
#                 fixed = TRUE)

readr::write_lines(x = fig_alt, file = paste0(dir_out, filename0, ".txt"))

```

```{r, fig.cap = fig_cap, fig.align = 'center', fig.width = 10.5, fig.height = 6.5, dpi = 320}
gg
```

